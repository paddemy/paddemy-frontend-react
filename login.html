<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Login</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; }
    form { display:flex; flex-direction:column; gap:10px; width:280px; }
    .error { color: #c00; }
    .info { color: #555; }
  </style>

  <!-- Guard + helpers en JS puro (se ejecuta antes que React) -->
  <script>
    const MEMBERS_PAGE = './members.html';
    function parseJwt(token) {
      try { return JSON.parse(atob(token.split('.')[1])); } catch { return null; }
    }
    function isTokenValid(token) {
      if (!token) return false;
      const p = parseJwt(token);
      // Si no tiene exp, lo tratamos como válido (o cámbialo a false si tu backend siempre manda exp)
      if (!p || !p.exp) return true;
      return p.exp * 1000 > Date.now();
    }
    (function guardIfAlreadyLogged() {
      const t = localStorage.getItem('token');
      if (isTokenValid(t)) {
        // Ya logueado → ir al dashboard sin dejar rastro en el historial
        window.location.replace(MEMBERS_PAGE);
      }
    })();
    function getQueryParam(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    function LoginForm() {
      const [username, setUsername] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [error, setError] = React.useState('');
      const [info, setInfo] = React.useState(() => {
        const reason = window.getQueryParam?.('reason');
        if (reason === 'expired') return 'Tu sesión expiró. Ingresa nuevamente.';
        if (reason === 'required') return 'Debes iniciar sesión para continuar.';
        return '';
      });

      async function handleLogin(e) {
        e.preventDefault();
        setError('');
        try {
          const res = await fetch('http://localhost:9090/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          if (!res.ok) throw new Error('Credenciales inválidas o error en el servidor');
          const data = await res.json();
          if (!data?.token) throw new Error('Respuesta sin token');

          // Guardar token (sync) y redirigir
          localStorage.setItem('token', data.token);
          window.location.replace('./members.html');
        } catch (err) {
          setError(err.message || 'Error desconocido');
        }
      }

      return (
        <form onSubmit={handleLogin}>
          <h2>Iniciar Sesión</h2>
          {info && <p className="info">{info}</p>}
          <input
            type="text"
            placeholder="Usuario"
            value={username}
            onChange={e => setUsername(e.target.value)}
            required
          />
          <input
            type="password"
            placeholder="Contraseña"
            value={password}
            onChange={e => setPassword(e.target.value)}
            required
          />
          <button type="submit">Ingresar</button>
          {error && <p className="error">{error}</p>}
        </form>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<LoginForm />);
  </script>
</body>
</html>
