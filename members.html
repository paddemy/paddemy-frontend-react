<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Members</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2c3e50;
      color: white;
      padding: 12px 20px;
    }
    header h2 {
      margin: 0;
      font-size: 1.2rem;
      text-transform: capitalize;
    }
    .user-menu {
      position: relative;
      cursor: pointer;
    }
    .user-name {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dropdown {
      position: absolute;
      right: 0;
      top: 120%;
      background: white;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-width: 150px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 10;
    }
    .dropdown a {
      padding: 10px;
      text-decoration: none;
      color: #333;
      font-size: 0.9rem;
    }
    .dropdown a:hover {
      background: #f0f0f0;
    }
    .user-menu.open .dropdown {
      display: flex;
    }

    main { padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    thead { background: #eee; }
    .error { color: #c00; }
  </style>

  <!-- Guard de sesión -->
  <script>
    const LOGIN_PAGE = './login.html';
    function parseJwt(token) {
      try { return JSON.parse(atob(token.split('.')[1])); } catch { return null; }
    }
    function isTokenValid(token) {
      if (!token) return false;
      const p = parseJwt(token);
      if (!p || !p.exp) return true;
      return p.exp * 1000 > Date.now();
    }
    (function guardMembers() {
      const t = localStorage.getItem('token');
      if (!isTokenValid(t)) {
        localStorage.removeItem('token');
        const url = new URL(LOGIN_PAGE, window.location.href);
        url.searchParams.set('reason', 'required');
        window.location.replace(url.toString());
      }
    })();
  </script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  function MembersPage() {
    const [members, setMembers] = React.useState([]);
    const [user, setUser] = React.useState(null);
    const [error, setError] = React.useState('');
    const [loading, setLoading] = React.useState(true);
    const [menuOpen, setMenuOpen] = React.useState(false);

    const token = React.useMemo(() => localStorage.getItem('token'), []);

    function hardLogout() {
      localStorage.removeItem('token');
      const url = new URL('./login.html', window.location.href);
      url.searchParams.set('reason', 'required');
      window.location.replace(url.toString());
    }

    React.useEffect(() => {
      let abort = false;

      async function fetchUser() {
        try {
          const res = await fetch('http://localhost:9090/members/me', {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (res.status === 401 || res.status === 403) return hardLogout();
          if (!res.ok) throw new Error('Error al obtener datos del usuario');
          const data = await res.json();
          if (!abort) setUser(data);
        } catch (err) {
          if (!abort) setError(err.message);
        }
      }

      async function fetchMembers() {
        try {
          const res = await fetch('http://localhost:9090/members', {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (res.status === 401 || res.status === 403) return hardLogout();
          if (!res.ok) throw new Error('Error al obtener members');
          const data = await res.json();
          if (!abort) setMembers(data);
        } catch (err) {
          if (!abort) setError(err.message);
        } finally {
          if (!abort) setLoading(false);
        }
      }

      fetchUser();
      fetchMembers();

      return () => { abort = true; };
    }, [token]);

    return (
        <div>
          <header>
            <h2>Members</h2>
            <div
                className={`user-menu ${menuOpen ? 'open' : ''}`}
                onClick={() => setMenuOpen(!menuOpen)}
            >
              <div className="user-name">
                <span>{user ? user.email : '...'}</span>
                <span>▾</span>
              </div>
              <div className="dropdown">
                <a href="#" onClick={hardLogout}>Cerrar sesión</a>
              </div>
            </div>
          </header>

          <main>
            {loading && <p>Cargando...</p>}
            {error && <p className="error">{error}</p>}

            {!loading && !error && (
                <table>
                  <thead>
                  <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Academy ID</th>
                    <th>Academy NIF</th>
                    <th>Academy Name</th>
                  </tr>
                  </thead>
                  <tbody>
                  {members.map(m => (
                      <tr key={m.id}>
                        <td>{m.id}</td>
                        <td>{m.email}</td>
                        <td>{m.role}</td>
                        <td>{m.academy?.id}</td>
                        <td>{m.academy?.nif}</td>
                        <td>{m.academy?.name}</td>
                      </tr>
                  ))}
                  </tbody>
                </table>
            )}
          </main>
        </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<MembersPage />);
</script>
</body>
</html>
